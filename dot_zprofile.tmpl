{{- $is_wsl := contains "Microsoft" .chezmoi.kernel.osrelease -}}

# Execute code that does not affect the current session in the background.
{
  # Compile the completion dump to increase startup speed.
  zcompdump="${ZDOTDIR:-$HOME}/.zcompdump"
  if [[ -s "$zcompdump" && (! -s "${zcompdump}.zwc" || "$zcompdump" -nt "${zcompdump}.zwc") ]]; then
    zcompile "$zcompdump"
  fi
} &!


#
# Editors
#

export EDITOR='vim'
export VISUAL='vim'
export PAGER='less'

#
# Language
#

if [[ -z "$LANG" ]]; then
  export LANG='en_US.UTF-8'
fi

#
# Paths
#

# Ensure path arrays do not contain duplicates.
typeset -gU cdpath fpath mailpath path

# Set the list of directories that cd searches.
# cdpath=(
#   $cdpath
# )

# Set the list of directories that Zsh searches for programs.
path=(
  /usr/local/{bin,sbin}
  $path
)

#
# Less
#

# Set the default Less options.
# Mouse-wheel scrolling has been disabled by -X (disable screen clearing).
# Remove -X and -F (exit if the content fits on one screen) to enable it.
export LESS='-F -g -i -M -R -S -w -X -z-4'

# Set the Less input preprocessor.
# Try both `lesspipe` and `lesspipe.sh` as either might exist on a system.
if (( $#commands[(i)lesspipe(|.sh)] )); then
  export LESSOPEN="| /usr/bin/env $commands[(i)lesspipe(|.sh)] %s 2>&-"
fi

export PATH="$HOME/.local/bin:$PATH"
{{- if has "cargo" .check.exec }}
export PATH="$HOME/.cargo/bin:$PATH"
{{- end }}
{{- if has "go" .check.exec }}
export PATH="$HOME/go/bin:$PATH"
{{- end }}
{{- if has "pyenv" .check.exec }}
# pyenv
export PYENV_ROOT={{ if eq .chezmoi.hostname "DreSRV" }}"/opt/pyenv"{{else}}"$HOME/.pyenv"{{end}}
export PATH="$PYENV_ROOT/bin:$PATH"
export PYENV_VIRTUALENV_DISABLE_PROMPT=1
{{- end }}
{{- if $is_wsl }}
if [[ -z $SSH_AUTH_SOCK ]]; then
  export SSH_AUTH_SOCK=${WSL_AUTH_SOCK}
fi
export GDK_SCALE=2
export QT_SCREEN_SCALE_FACTORS=2
export QT_AUTO_SCREEN_SCALE_FACTOR=0
export DISPLAY=localhost:0.0
{{- else }}
{{- if or (eq .chezmoi.hostname "desktop") (eq .chezmoi.hostname "laptop") }}
{{- if ne .chezmoi.username "root" }}
# Ensure tunnel is active
systemctl --user -q is-active tunnel-dresrv.service || systemctl --user start tunnel-dresrv.service &
# Start X server
if systemctl -q is-active graphical.target && [[ ! $DISPLAY && $TTY = /dev/tty1 ]]; then
  exec startx
fi
if [[ -z $SSH_AUTH_SOCK ]]; then
  eval $(/usr/bin/gnome-keyring-daemon --start --components=pkcs11,secrets,ssh)
  export SSH_AUTH_SOCK
fi
{{- else }}
if [[ -z $SSH_AUTH_SOCK ]]; then
    export SSH_AUTH_SOCK=/run/user/1000/keyring/ssh
fi
{{- end }}
{{- end }}
{{- end }}
