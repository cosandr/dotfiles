{{- $is_mac := eq .chezmoi.os "darwin" -}}
{{- $is_wsl := false -}}
{{- if not $is_mac -}}
{{- $is_wsl := hasSuffix "Microsoft" .chezmoi.kernel.osrelease -}}
{{- end -}}

# Execute code that does not affect the current session in the background.
{
  # Compile the completion dump to increase startup speed.
  zcompdump="${ZDOTDIR:-$HOME}/.zcompdump"
  if [[ -s "$zcompdump" && (! -s "${zcompdump}.zwc" || "$zcompdump" -nt "${zcompdump}.zwc") ]]; then
    zcompile "$zcompdump"
  fi
} &!


#
# Editors
#

export EDITOR='vim'
export VISUAL='vim'
export PAGER='less'

#
# Language
#

if [[ -z "$LANG" ]]; then
  export LANG='en_US.UTF-8'
fi

#
# Paths
#

# Ensure path arrays do not contain duplicates.
typeset -gU cdpath fpath mailpath path

# Set the list of directories that cd searches.
# cdpath=(
#   $cdpath
# )

# Set the list of directories that Zsh searches for programs.
path=(
  /usr/local/{bin,sbin}
  $path
)

# Set the default Less options.
{{- if $is_mac }}
export LESS='-F -g -i -M -R -S -w -X -z-4'
{{- else }}
{{- if or (eq .chezmoi.osRelease.id "arch") (eq .chezmoi.osRelease.id "fedora") }}
export LESS='-F -g -i -M -R -S -w -X -z-4 --mouse --wheel-lines 4'
{{- else }}
export LESS='-F -g -i -M -R -S -w -X -z-4'
{{- end }}
{{- end }}

# Set the Less input preprocessor.
# Try both `lesspipe` and `lesspipe.sh` as either might exist on a system.
if (( $#commands[(i)lesspipe(|.sh)] )); then
  export LESSOPEN="| /usr/bin/env $commands[(i)lesspipe(|.sh)] %s 2>&-"
fi

export PATH="$HOME/.local/bin:$PATH"
{{- if has "cargo" .check.exec }}
export PATH="$HOME/.cargo/bin:$PATH"
{{- end }}
{{- if has "go" .check.exec }}
export PATH="$HOME/go/bin:$PATH"
{{- end }}
{{- if has "pyenv" .check.exec }}
# pyenv
export PYENV_ROOT={{ if eq .chezmoi.hostname "DreSRV" }}"/opt/pyenv"{{else}}"$HOME/.pyenv"{{end}}
export PATH="$PYENV_ROOT/bin:$PATH"
export PYENV_VIRTUALENV_DISABLE_PROMPT=1
{{- end }}
{{- if $is_wsl }}
if [[ -z $SSH_AUTH_SOCK ]]; then
  export SSH_AUTH_SOCK=${WSL_AUTH_SOCK}
fi
export GDK_SCALE=2
export QT_SCREEN_SCALE_FACTORS=2
export QT_AUTO_SCREEN_SCALE_FACTOR=0
export DISPLAY=localhost:0.0
{{- else if $is_mac }}
#export PATH="$PATH:/Applications/Visual Studio Code.app/Contents/Resources/app/bin"
{{- else }}
{{- if or (eq .chezmoi.hostname "desktop") (eq .chezmoi.hostname "laptop") }}
{{- if ne .chezmoi.username "root" }}
# Ensure tunnel is active
systemctl --user -q is-active tunnel-dresrv.service || systemctl --user start --no-block tunnel-dresrv.service
# Start X server
if [[ -z "$DISPLAY" && "$(tty)" = "/dev/tty1" ]]; then
  systemctl -q is-active graphical.target && exec startx
fi
if [[ -z $SSH_AUTH_SOCK ]]; then
  eval $(/usr/bin/gnome-keyring-daemon --start --components=pkcs11,secrets,ssh)
  export SSH_AUTH_SOCK
fi
{{- else }}
if [[ -z $SSH_AUTH_SOCK ]]; then
  export SSH_AUTH_SOCK=${XDG_RUNTIME_DIR}/keyring/ssh
fi
{{- end }}
{{- end }}
{{- end }}
