#!/bin/bash

[[ -f ~/.Xresources ]] && xrdb -merge -I$HOME ~/.Xresources

eval $(/usr/bin/gnome-keyring-daemon --start --components=pkcs11,secrets,ssh)

[[ -f ~/.config/override/xinitrc ]] && source ~/.config/override/xinitrc
LANG=${LANG:-en_US.UTF-8}
LC_TIME=${LC_TIME:-en_GB.UTF-8}
HOSTNAME=${HOSTNAME:-"{{ .chezmoi.hostname }}"}

{{- if .is.desktop }}
QT_AUTO_SCREEN_SCALE_FACTOR=${QT_AUTO_SCREEN_SCALE_FACTOR:-0}
QT_SCALE_FACTOR=${QT_SCALE_FACTOR:-1.1}
MOUSE_SENS=${MOUSE_SENS:--0.65}
MOUSE_NAME=${MOUSE_NAME:-"pointer:Logitech G502"}
NVIDIA_CORE_OFFSET=${NVIDIA_CORE_OFFSET:-50}
NVIDIA_MEM_OFFSET=${NVIDIA_MEM_OFFSET:-1100}
# Lower mouse sensitivity
xinput set-prop "$MOUSE_NAME" 'libinput Accel Speed' "$MOUSE_SENS"
# Nvidia OC
nvidia-settings -a "[gpu:0]/GPUGraphicsClockOffsetAllPerformanceLevels=$NVIDIA_CORE_OFFSET" -a "[gpu:0]/GPUMemoryTransferRateOffsetAllPerformanceLevels=$NVIDIA_MEM_OFFSET"
{{- else if .is.laptop }}
# Invert scrolling
TOUCHPAD_NAME=${TOUCHPAD_NAME:-"bcm5974"}
TOUCHPAD_TAP=${TOUCHPAD_TAP:-"0"}
TOUCHPAD_NATURAL_SCROLL=${TOUCHPAD_NATURAL_SCROLL:-"1"}
xinput set-prop "$TOUCHPAD_NAME" 'libinput Natural Scrolling Enabled' "$TOUCHPAD_NATURAL_SCROLL"
xinput set-prop "$TOUCHPAD_NAME" 'libinput Tapping Enabled' "$TOUCHPAD_TAP"
QT_AUTO_SCREEN_SCALE_FACTOR=${QT_AUTO_SCREEN_SCALE_FACTOR:-1}
QT_SCALE_FACTOR=${QT_SCALE_FACTOR:-1.1}
GDK_SCALE=${GDK_SCALE:-2}
GDK_DPI_SCALE=${GDK_DPI_SCALE:-0.5}
MOZ_X11_EGL=${MOZ_X11_EGL:-1}
{{- end }}
export HOSTNAME
export LANG
export LC_TIME
export QT_AUTO_SCREEN_SCALE_FACTOR
export QT_SCALE_FACTOR
export QT_QPA_PLATFORMTHEME=qt5ct
export GDK_SCALE
export GDK_DPI_SCALE
export MOZ_X11_EGL
export SSH_AUTH_SOCK
export XDG_CACHE_HOME={{ .chezmoi.homedir }}/.cache
export XDG_CONFIG_HOME={{ .chezmoi.homedir }}/.config
export XDG_DATA_HOME={{ .chezmoi.homedir }}/.local/share
export XDG_SESSION_DESKTOP=i3
export XDG_SESSION_TYPE=x11

{{ .chezmoi.homedir }}/.local/bin/xorg-conf

dbus-update-activation-environment --systemd DISPLAY PATH XDG_SESSION_ID XAUTHORITY
setxkbmap -layout us,no -option grp:rctrl_rshift_toggle
exec i3
