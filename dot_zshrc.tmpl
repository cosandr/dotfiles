#
# Executes commands at the start of an interactive session.
#
# Authors:
#   Sorin Ionescu <sorin.ionescu@gmail.com>
#

# Source Prezto
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

{{- range splitList " " .src_list }}
{{ if . }}source {{ . }}{{ end }}
{{- end }}

# Don't save failed commands
zshaddhistory() { whence ${${(z)1}[1]} >| /dev/null || return 1 }
setopt hist_ignore_dups
setopt hist_expire_dups_first
unsetopt correct

dirbg='white'
dirfg='black'

#
# P9K
#

DEFAULT_USER=andrei
POWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(dir_writable dir vcs pyenv)
POWERLEVEL9K_RIGHT_PROMPT_ELEMENTS=(status history context)
POWERLEVEL9K_DIR_SHOW_WRITABLE=false
POWERLEVEL9K_ALWAYS_SHOW_CONTEXT=true
POWERLEVEL9K_CONTEXT_DEFAULT_FOREGROUND='white'
POWERLEVEL9K_CONTEXT_ROOT_FOREGROUND='red'
POWERLEVEL9K_CONTEXT_SUDO_FOREGROUND='orange'
POWERLEVEL9K_CONTEXT_REMOTE_FOREGROUND='wheat1'
POWERLEVEL9K_CONTEXT_REMOTE_SUDO_FOREGROUND='yellow1'
# Backgrounds
POWERLEVEL9K_DIR_DEFAULT_BACKGROUND=$dirbg
POWERLEVEL9K_DIR_HOME_BACKGROUND=$dirbg
POWERLEVEL9K_DIR_HOME_SUBFOLDER_BACKGROUND=$dirbg
POWERLEVEL9K_DIR_ETC_BACKGROUND=$dirbg
POWERLEVEL9K_DIR_WRITABLE_FORBIDDEN_BACKGROUND=$dirbg
# Foregrounds
POWERLEVEL9K_DIR_DEFAULT_FOREGROUND=$dirfg
POWERLEVEL9K_DIR_HOME_FOREGROUND=$dirfg
POWERLEVEL9K_DIR_HOME_SUBFOLDER_FOREGROUND=$dirfg
POWERLEVEL9K_DIR_ETC_FOREGROUND=$dirfg
POWERLEVEL9K_DIR_WRITABLE_FORBIDDEN_FOREGROUND=$dirfg

alias cpp='rsync -avh --no-compress --progress'
alias mvp='rsync -avh --no-compress --progress --remove-source-files'
{{- $avail_list := splitList " " .avail_cmds -}}
{{- if has "corefreq-cli" $avail_list }}
alias tmux-mon='tmux new -s mon  "htop -d10" \; split-window "corefreq-cli" \; select-layout even-vertical'
{{- end }}
{{- if has "pyenv" $avail_list }}
# pyenv
export PYENV_ROOT="/{{ if eq .chezmoi.hostname "DreSRV"}}"/opt/pyenv"{{else}}"\$HOME/.pyenv"{{end}}"
export PATH="$PYENV_ROOT/bin:$PATH"
export PYENV_VIRTUALENV_DISABLE_PROMPT=1
if command -v pyenv 1>/dev/null 2>&1; then
	eval "$(pyenv init -)"
	eval "$(pyenv virtualenv-init -)"
fi
{{- end }}
{{- if has "go" $avail_list }}
export PATH="$HOME/go/bin:$PATH"
{{- end }}
{{- if has "virsh" $avail_list }}
alias virsh='virsh --connect qemu:///system'
alias virt-install='virt-install --connect qemu:///system'
{{- end }}
{{- if has "dotnet" $avail_list }}
_dotnet_zsh_complete() 
{
  local completions=("$(dotnet complete "$words")")

  reply=( "${(ps:\n:)completions}" )
}

compctl -K _dotnet_zsh_complete dotnet
{{- end }}
{{- if has "cargo" $avail_list }}
export PATH="$HOME/.cargo/bin:$PATH"
{{- end }}
{{- if eq .chezmoi.hostname "DreSRV" }}
export GPG_TTY=$(tty)
{{- end }}
alias cosandr='git config user.email "{{ .private_email }}" && git config user.name "{{ .private_name }}"'
alias dls='docker container ls -a --format "table {{ "{{.Names}}" }}\t{{ "{{.Status}}" }}\t{{ "{{.RunningFor}}" }}\t"'
{{- if has "go-motd" $avail_list }}
go-motd -cfg ~/go/src/github.com/cosandr/go-motd/config.yaml
{{- end }}
