#!/usr/bin/env bash

# https://github.com/oakszyjrnrdy/betterlockscreen_rapid
# https://github.com/pavanjadhaw/betterlockscreen/commit/643ea70aa77686ebe84889943a258b890dffe2fb

# Do nothing if running from systemd and swayidle is running
[[ $SYSTEMD_SUSPEND -eq 1 ]] && pgrep -u {{ .chezmoi.username }} swayidle && exit 0

OPTS=""
LOCKER=${LOCKER:-{{ if lookPath "i3lock-fancy-rapid"}}i3lock-fancy-rapid{{ else }}i3lock{{ end }}}
WAYLAND_LOCKER=${WAYLAND_LOCKER:-swaylock}

insidecolor='00000000'
ringcolor='ffffffff'
keyhlcolor='d23c3dff'
bshlcolor='d23c3dff'
separatorcolor='00000000'
insidevercolor='00000000'
insidewrongcolor='d23c3dff'
ringvercolor='ffffffff'
ringwrongcolor='ffffffff'
verifcolor='ffffffff'
timecolor='ffffffff'
datecolor='ffffffff'
font='Noto Sans'
locktext='Type password to unlock...'
# Adding width and height for multiple monitors
xpos={{- if .is.desktop }}"w+x"{{- else }}"x"{{- end }}
ypos={{- if .is.desktop }}"y+h"{{- else }}"h"{{- end }}

[[ -f ~/.config/override/lock ]] && source ~/.config/override/lock

if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
    trap 'swaymsg output "*" dpms on' EXIT
    case "$WAYLAND_LOCKER" in
        swaylock)
            # We have swaylock-effects
            if [[ $(swaylock --help 2>&1) =~ "--screenshots" ]]; then
                WAYLAND_OPTS=${WAYLAND_OPTS:-"-f -i $HOME/.wallpaper --clock --indicator --effect-blur 7x5 --effect-vignette 0.5:0.5 --grace 2"}
            else
                WAYLAND_OPTS=${WAYLAND_OPTS:-"-f -i $HOME/.wallpaper"}
            fi
            swaylock $WAYLAND_OPTS
            ;;
        waylock)
            WAYLAND_OPTS=${WAYLAND_OPTS:-"--init-color 0x002b36 --input-color 0x586e75 --fail-color 0x002b36"}
            waylock $WAYLAND_OPTS
            ;;
    esac
    exit 0
fi

default_timeout=$(cut -d ' ' -f4 <<< "$(xset q | sed -n '25p')")
lock_timeout="30"

revert() {
    # Do nothing if timeout was disabled before
    [[ $default_timeout -eq 0 ]] && exit 0
    current_timeout=$(cut -d ' ' -f4 <<< "$(xset q | sed -n '25p')")
    if [[ $current_timeout -ne $default_timeout ]]; then
        xset dpms "$default_timeout" "$default_timeout" "$default_timeout"
    fi
}
trap revert EXIT

if [[ $default_timeout -gt $lock_timeout ]]; then
    xset dpms "$lock_timeout" "$lock_timeout" "$lock_timeout"
fi

# Check if we have i3lock-color
if [[ $(i3lock --version 2>&1) =~ "Raymond Li" ]]; then
    i3lock_color="303030ff"
    i3lock_args="--ignore-empty-password --pass-media-keys --nofork $OPTS"
else
    i3lock_color="303030"
    i3lock_args="--ignore-empty-password --nofork $OPTS"
fi

case "$LOCKER" in
    sxlock)
        sxlock -d
        ;;
    i3lock)
        i3lock $i3lock_args --color "$i3lock_color"
        ;;
    i3lock-fancy-rapid)
        radius=6
        times=3
        i3lock-fancy-rapid "$radius" "$times" \
            $i3lock_args \
            --tiling \
            --time-pos "$xpos+110:$ypos-70" \
            --date-pos "$xpos+43:$ypos-45" \
            --clock --date-align 1 --date-str "$locktext" \
            --inside-color "$insidecolor" --ring-color "$ringcolor" --line-uses-inside \
            --keyhl-color "$keyhlcolor" --bshl-color "$bshlcolor" --separator-color "$separatorcolor" \
            --insidever-color "$insidevercolor" --insidewrong-color "$insidewrongcolor" \
            --ringver-color "$ringvercolor" --ringwrong-color "$ringwrongcolor" --ind-pos "$xpos+280:$ypos-70" \
            --radius "20" --ring-width "4" --verif-text '' --wrong-text '' \
            --verif-color "$verifcolor" --time-color "$timecolor" --date-color "$datecolor" \
            --time-font "$font" --date-font "$font" --layout-font "$font" --verif-font "$font" --wrong-font "$font" \
            --noinput-text ''
        ;;
esac
